<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Justcogs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        body {
            margin: 24px;
        }
        #releases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .release-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .release-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
        }
        .release-card > div {
            font-size: 0.9em;
            line-height: 1.4;
        }
        .release-card .artist {
            font-weight: 400;
        }
        .release-card .title {
            color: #333;
            font-weight: 600;
        }
        .release-card .year {
            color: #666;
            font-size: 0.85em;
        }
        .release-card .genres {
            font-size: 0.8em;
            margin-top: 4px;
        }
        .release-card [class^="rating-"] {
            color: #666;
            font-size: 0.85em;
        }
        #search-container {
            position: relative;
            margin-bottom: 20px;
        }
        #search-input {
            height: 40px;
            padding: 0 40px 0 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        #clear-link {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
            font-size: 20px;
            line-height: 1;
            font-weight: 300;
        }
        #clear-link:hover {
            color: #000;
        }
        #header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #header-container h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 600;
        }
        #lucky-link {
            color: #06c;
            text-decoration: none;
            cursor: pointer;
            font-size: 0.9em;
        }
        #lucky-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 1100px) {
            body {
                margin: 16px;
            }
            #releases-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 16px;
            }
            .release-card > div {
                font-size: 0.88em;
            }
            .release-card .year {
                font-size: 0.82em;
            }
            .release-card .genres {
                font-size: 0.76em;
            }
        }
        @media (max-width: 767px) {
            body {
                margin: 16px;
            }
            #releases-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 14px;
            }
            .release-card > div {
                font-size: 0.85em;
            }
            .release-card .year {
                font-size: 0.8em;
            }
            .release-card .genres {
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div id="header-container">
        <h1>Justcogs</h1>
        <a id="lucky-link" href="#">Surprise me!</a>
    </div>
    <div id="last-sync" style="margin-bottom: 12px; font-size: 0.9em; color: #666;"></div>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search..." />
        <span id="clear-link">Ã—</span>
    </div>
    <div id="collection"></div>

    <script>
        // Store all releases globally
        let allReleases = [];
        let totalItems = 0;
        let searchQuery = '';
        let lastUpdated = null; // Store last update timestamp

        function escapeHtml(s) {
            const t = String(s);
            return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function getReleaseGenres(release) {
            const basicInfo = release.basic_information || {};
            const genres = (basicInfo.genres || []).map((g) => (g || '').trim()).filter(Boolean);
            const styles = (basicInfo.styles || []).map((s) => (s || '').trim()).filter(Boolean);
            return [...new Set([...genres, ...styles])];
        }

        function releaseMatchesSearch(release, q) {
            const basicInfo = release.basic_information || {};
            const artist = (basicInfo.artists?.[0]?.name || '').toLowerCase();
            const title = (basicInfo.title || '').toLowerCase();
            const genres = getReleaseGenres(release).map((g) => g.toLowerCase());
            return artist.includes(q) || title.includes(q) || genres.some((g) => g.includes(q));
        }

        async function applySearchFilter() {
            const q = searchQuery.trim().toLowerCase();
            const filtered = q === '' ? allReleases : allReleases.filter((r) => releaseMatchesSearch(r, q));
            // Sort by album name (title)
            const sorted = [...filtered].sort((a, b) => {
                const titleA = (a.basic_information?.title || '').toLowerCase();
                const titleB = (b.basic_information?.title || '').toLowerCase();
                return titleA.localeCompare(titleB);
            });
            displayReleases(sorted, sorted.length);
        }

        function getRating(release) {
            // First, try to get the community rating from cached data
            if (release.community_rating !== undefined && release.community_rating !== null) {
                return release.community_rating;
            }
            
            // If not available in cache and we're on localhost, we could fetch it
            // But for now, just return null if not in cached data
            return null;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return null;
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            const diffWeeks = Math.floor(diffDays / 7);
            const diffMonths = Math.floor(diffDays / 30);
            const diffYears = Math.floor(diffDays / 365);

            if (diffSeconds < 60) {
                return 'just now';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else if (diffWeeks < 4) {
                return `${diffWeeks} week${diffWeeks !== 1 ? 's' : ''} ago`;
            } else if (diffMonths < 12) {
                return `${diffMonths} month${diffMonths !== 1 ? 's' : ''} ago`;
            } else {
                return `${diffYears} year${diffYears !== 1 ? 's' : ''} ago`;
            }
        }

        function displayReleases(releases, count) {
            const collectionDiv = document.getElementById('collection');
            const lastSyncDiv = document.getElementById('last-sync');
            
            // Update last API sync timestamp with album count
            const albumCount = allReleases.length;
            if (lastUpdated) {
                const timestampText = formatTimestamp(lastUpdated);
                if (timestampText) {
                    lastSyncDiv.textContent = `${albumCount} album${albumCount !== 1 ? 's' : ''}. Last sync: ${timestampText}`;
                } else {
                    lastSyncDiv.textContent = `${albumCount} album${albumCount !== 1 ? 's' : ''}`;
                }
            } else {
                lastSyncDiv.textContent = `${albumCount} album${albumCount !== 1 ? 's' : ''}`;
            }
            
            // No header HTML needed (removed "Your Collection" line)
            let headerHTML = '';
            
            // Display releases in a grid layout
            const releasesHTML = releases.map((release, index) => {
                const basicInfo = release.basic_information || {};
                const artist = basicInfo.artists?.[0]?.name || '';
                const title = basicInfo.title || '';
                const year = basicInfo.year || '';
                const coverImage = basicInfo.cover_image || basicInfo.thumb || '';
                const releaseId = basicInfo.id;
                const discogsUrl = releaseId ? `https://www.discogs.com/release/${releaseId}` : '';
                const genres = getReleaseGenres(release);
                const genreLinks = genres.map((g) => `<span class="genre-link" data-genre="${escapeHtml(g)}" style="color: #06c; text-decoration: underline; cursor: pointer;">${escapeHtml(g)}</span>`).join(', ');

                return `
                    <div id="release-${releaseId}" data-release-id="${releaseId}" class="release-card">
                        ${coverImage ? `<img src="${coverImage}" alt="${escapeHtml(artist)} - ${escapeHtml(title)}" />` : ''}
                        <div class="title">${escapeHtml(title)}</div>
                        <div class="artist"><span class="artist-link" data-artist="${escapeHtml(artist)}" style="color: #06c; text-decoration: underline; cursor: pointer;">${escapeHtml(artist)}</span></div>
                        ${year ? `<div class="year">${escapeHtml(year)}</div>` : ''}
                        <div class="rating-${releaseId}">-</div>
                        ${genreLinks ? `<div class="genres">${genreLinks}</div>` : ''}
                    </div>
                `;
            }).join('');

            collectionDiv.innerHTML = headerHTML + `<div id="releases-grid">${releasesHTML}</div>`;

            // Display ratings from cached data
            releases.forEach((release) => {
                const basicInfo = release.basic_information || {};
                const releaseId = basicInfo.id;
                if (releaseId) {
                    const rating = getRating(release);
                    const ratingElement = document.querySelector(`.rating-${releaseId}`);
                    if (ratingElement) {
                        let ratingDisplay = 'No rating';
                        if (rating !== null && rating !== undefined && rating > 0) {
                            // If it's a whole number, don't show decimal
                            const rounded = rating.toFixed(1);
                            const formatted = rounded.endsWith('.0') ? rounded.slice(0, -2) : rounded;
                            ratingDisplay = `Rating: ${formatted}/5`;
                        }
                        ratingElement.textContent = ratingDisplay;
                    }
                }
            });
        }

        async function loadCachedCollection() {
            // Try multiple paths to handle different hosting scenarios
            const paths = [
                'data/collection.json',  // Relative path (GitHub Pages)
                '/data/collection.json', // Absolute path (local server)
                './data/collection.json' // Explicit relative (file://)
            ];
            
            const errors = [];
            for (const path of paths) {
                try {
                    console.log(`Attempting to load from: ${path}`);
                    const response = await fetch(path);
                    console.log(`Response status for ${path}:`, response.status, response.statusText);
                    console.log(`Response headers:`, Object.fromEntries(response.headers.entries()));
                    
                    if (response.ok) {
                        const text = await response.text();
                        console.log(`Response text length: ${text.length} characters`);
                        console.log(`First 200 chars:`, text.substring(0, 200));
                        
                        try {
                            const data = JSON.parse(text);
                            console.log(`Parsed JSON successfully. Keys:`, Object.keys(data));
                            if (data && data.releases && Array.isArray(data.releases)) {
                                console.log(`Successfully loaded ${data.releases.length} releases from ${path}`);
                                return data;
                            } else {
                                console.warn(`Data loaded from ${path} but invalid format. Data structure:`, data);
                                errors.push(`${path}: Invalid data structure - missing releases array`);
                            }
                        } catch (parseErr) {
                            console.error(`Failed to parse JSON from ${path}:`, parseErr);
                            errors.push(`${path}: JSON parse error - ${parseErr.message}`);
                        }
                    } else {
                        const errorText = await response.text().catch(() => '');
                        errors.push(`${path}: ${response.status} ${response.statusText} - ${errorText.substring(0, 100)}`);
                    }
                } catch (err) {
                    errors.push(`${path}: ${err.message}`);
                    console.error(`Error loading ${path}:`, err);
                }
            }
            
            // If all paths failed, log for debugging
            console.error('Failed to load collection.json from all attempted paths:', paths);
            console.error('Errors:', errors);
            console.error('Current URL:', window.location.href);
            console.error('Protocol:', window.location.protocol);
            return null;
        }

        // API fetching is disabled; function retained for compatibility, but always throws
        async function fetchCollectionFromAPI() {
            throw new Error('API calls are disabled. Only cached data is available.');
        }

        async function fetchCollection() {
            const collectionDiv = document.getElementById('collection');
            const lastSyncDiv = document.getElementById('last-sync');
            lastSyncDiv.textContent = 'Loading...';

            try {
                // Always load from cached data
                const cachedData = await loadCachedCollection();
                if (cachedData && cachedData.releases && cachedData.releases.length > 0) {
                    allReleases = cachedData.releases;
                    totalItems = cachedData.pagination?.items || cachedData.releases.length;
                    lastUpdated = cachedData.lastUpdated || null;
                } else {
                    const protocol = window.location.protocol;
                    const currentUrl = window.location.href;
                    let errorMsg = 'Cached collection data not available. ';
                    errorMsg += `(Current URL: ${currentUrl}) `;
                    if (protocol === 'file:') {
                        errorMsg += 'You are opening the HTML file directly. Please run `node server.js` and access the page via http://localhost:3000';
                    } else if (currentUrl.includes('localhost') || currentUrl.includes('127.0.0.1')) {
                        errorMsg += 'Make sure `node server.js` is running. Check the browser console (F12) for detailed error messages.';
                    } else {
                        errorMsg += 'The GitHub Actions workflow should create data/collection.json. Please check if the workflow has run successfully. Check the browser console (F12) for detailed error messages.';
                    }
                    throw new Error(errorMsg);
                }
                await applySearchFilter();
            } catch (error) {
                collectionDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const clearLink = document.getElementById('clear-link');
            const collectionDiv = document.getElementById('collection');
            function updateClearVisibility() {
                clearLink.style.display = searchInput.value.trim() ? 'flex' : 'none';
            }
            searchInput.addEventListener('input', () => {
                searchQuery = searchInput.value;
                updateClearVisibility();
                applySearchFilter();
            });
            clearLink.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                updateClearVisibility();
                applySearchFilter();
            });
            collectionDiv.addEventListener('click', (e) => {
                // Handle genre link clicks
                const genreLink = e.target.closest('.genre-link');
                if (genreLink) {
                    e.preventDefault();
                    const genre = genreLink.getAttribute('data-genre');
                    if (genre != null) {
                        searchInput.value = genre;
                        searchQuery = genre;
                        updateClearVisibility();
                        applySearchFilter();
                    }
                    return;
                }
                
                // Handle artist link clicks
                const artistLink = e.target.closest('.artist-link');
                if (artistLink) {
                    e.preventDefault();
                    const artist = artistLink.getAttribute('data-artist');
                    if (artist != null) {
                        searchInput.value = artist;
                        searchQuery = artist;
                        updateClearVisibility();
                        applySearchFilter();
                    }
                    return;
                }
                
                // Don't prevent default for other clicks (like album cover links)
            });
            
            // Handle "Surprise me!" click
            const luckyLink = document.getElementById('lucky-link');
            luckyLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (allReleases.length === 0) {
                    return;
                }
                
                // Get a random release
                const randomIndex = Math.floor(Math.random() * allReleases.length);
                const randomRelease = allReleases[randomIndex];
                const albumTitle = randomRelease.basic_information?.title || '';
                
                if (albumTitle) {
                    // Set the search input to the album title
                    searchInput.value = albumTitle;
                    searchQuery = albumTitle;
                    updateClearVisibility();
                    
                    // Apply the search filter to show only this album
                    applySearchFilter();
                    
                    // Scroll to top to see the result
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            fetchCollection();
        });
    </script>
</body>
</html>
